version: 2

models:
  - name: mart_funnel_conversions
    description: |
      Funnel session conversion tracking.
      Grain: One row per funnel session (converted or not).

      Conversion Types:
      1. subscription_activated - User initiated checkout (subscription created in any status)
      2. trial_started          - User started a trial period (status = 'trialing')
      3. trial_converted        - Trial subscription with successful payment
      4. direct_paid            - Non-trial subscription with successful payment
      5. paid_successfully      - Any successful Stripe charge

      Use cases:
      - Multi-stage funnel analysis (attempt → trial → payment)
      - Conversion rate analysis by funnel
      - Time-to-convert distribution
      - Geographic conversion analysis
      - Traffic source performance
    columns:
      - name: session_id
        description: FunnelFox session ID (primary key)
        tests:
          - unique
          - not_null

      - name: profile_id
        description: User profile ID
        tests:
          - not_null

      - name: session_date
        description: Date of session (UTC)
        tests:
          - not_null

      - name: session_timestamp
        description: Exact timestamp of session (UTC)

      - name: funnel_id
        description: ID of the funnel
        tests:
          - not_null

      - name: funnel_title
        description: Name of the funnel

      - name: funnel_type
        description: Type of funnel

      - name: funnel_environment
        description: Funnel environment (dev, staging, prod)

      - name: funnel_version
        description: Version of the funnel at time of session

      - name: country
        description: User's country

      - name: city
        description: User's city

      - name: traffic_source
        description: Traffic source/origin

      - name: subscription_activated
        description: "Stage 1: User initiated checkout (subscription created in any status)"
        tests:
          - not_null
          - accepted_values:
              values: [0, 1]

      - name: trial_started
        description: "Stage 2: User started a trial period (subscription status = 'trialing')"
        tests:
          - not_null
          - accepted_values:
              values: [0, 1]

      - name: trial_converted
        description: "Stage 2b: Trial subscription with successful payment"
        tests:
          - not_null
          - accepted_values:
              values: [0, 1]

      - name: direct_paid
        description: "Stage 3a: Non-trial subscription with successful payment"
        tests:
          - not_null
          - accepted_values:
              values: [0, 1]

      - name: paid_successfully
        description: "Stage 3: User completed payment (any successful Stripe charge)"
        tests:
          - not_null
          - accepted_values:
              values: [0, 1]

      - name: converted
        description: "Legacy: Binary flag (1 = subscription exists, 0 = not). Use paid_successfully for actual payments."
        tests:
          - not_null
          - accepted_values:
              values: [0, 1]

      - name: had_purchase
        description: Boolean flag for whether session resulted in successful Stripe charge
        tests:
          - not_null

      - name: revenue_usd
        description: Revenue in USD if converted (null if not)

      - name: subscription_status
        description: FunnelFox subscription status (active, trialing, created, etc.)

      - name: currency
        description: Currency code if converted

      - name: time_to_conversion_hours
        description: Hours from session to conversion (null if not converted)

      - name: conversion_timestamp
        description: Timestamp of conversion (null if not converted)

      - name: conversion_date
        description: Date of conversion (null if not converted)

  - name: mart_stripe_payments_daily
    description: |
      Daily aggregated Stripe payment metrics.
      Grain: One row per day + funnel + card_country + card_brand + description.

      Use cases:
      - Daily payment dashboard
      - Success rate trends
      - Failure category breakdown
      - Recovery rate monitoring
    columns:
      - name: date
        description: The date
        tests:
          - not_null

      - name: funnel_name
        description: Funnel name (null for all funnels)

      - name: card_country
        description: Card country (null for all countries)

      - name: card_brand
        description: Card brand (null for all brands)

      - name: description
        description: Payment description from Stripe charge (e.g., "Subscription creation", "Subscription update")

      - name: total_attempts
        description: Total payment attempts
        tests:
          - not_null

      - name: successful_payments
        description: Count of successful payments
        tests:
          - not_null

      - name: failed_payments
        description: Count of failed payments
        tests:
          - not_null

      - name: success_rate
        description: Success rate (0.0 - 1.0)

      - name: gross_revenue_usd
        description: Sum of successful payment amounts

      - name: failed_revenue_usd
        description: Sum of failed payment amounts (potential lost revenue)

      - name: refunded_usd
        description: Sum of refunded amounts (USD)

      - name: refund_count
        description: Count of payments that have been refunded

      - name: net_revenue_usd
        description: Net revenue after refunds (gross_revenue_usd - refunded_usd)

      - name: refund_rate
        description: Refund rate (refunded_usd / gross_revenue_usd)

      - name: aov_all_tries_usd
        description: Average order value across all attempts ((gross_revenue + failed_revenue) / total_attempts)

      - name: aov_success_usd
        description: Average order value for successful payments (gross_revenue / successful_payments)

      - name: failures_insufficient_funds
        description: Count of insufficient funds failures

      - name: failures_card_declined
        description: Count of card declined failures

      - name: failures_fraud_block
        description: Count of fraud block failures

      - name: failures_authentication_required
        description: Count of authentication required failures

      - name: failures_technical_error
        description: Count of technical error failures

      - name: failures_other
        description: Count of other failures

      - name: intents_with_retry
        description: Payment intents that had multiple attempts

      - name: intents_recovered
        description: Failed intents that eventually succeeded

      - name: recovery_rate
        description: Recovery rate (recovered / intents_with_retry)

  - name: mart_funnel_performance
    description: |
      Funnel performance metrics by time period and traffic source.
      Grain: One row per funnel + date + traffic source.

      Conversion Metrics:
      1. subscriptions_activated - Users who initiated checkout (subscription created)
      2. trials_started          - Users who started a trial period
      3. trials_converted        - Trial subscriptions with successful payment
      4. direct_payments         - Non-trial subscriptions with successful payment
      5. paid_successfully       - Users who completed payment (any successful charge)

      Use cases:
      - Daily/weekly/monthly funnel conversion reporting
      - Traffic source performance (Facebook, Instagram, TikTok, organic)
      - Facebook/Instagram attribution analysis
      - Amplitude engagement correlation
      - Multi-stage funnel analysis (attempt → trial → payment)
    columns:
      - name: date
        description: Date (UTC, daily grain)
        tests:
          - not_null

      - name: funnel_id
        description: Funnel identifier
        tests:
          - not_null

      - name: funnel_title
        description: Funnel name

      - name: funnel_type
        description: Type of funnel

      - name: traffic_source
        description: Traffic source detected from user agent (facebook, instagram, tiktok, organic)
        tests:
          - not_null
          - accepted_values:
              values: ['facebook', 'instagram', 'tiktok', 'organic']

      - name: total_sessions
        description: Count of funnel sessions
        tests:
          - not_null

      - name: unique_users
        description: Distinct user profile count
        tests:
          - not_null

      - name: subscriptions_activated
        description: "Stage 1: Count of sessions where user initiated checkout (subscription created)"
        tests:
          - not_null

      - name: trials_started
        description: "Stage 2: Count of sessions where user started a trial"
        tests:
          - not_null

      - name: trials_converted
        description: "Stage 2b: Count of trial subscriptions with successful payment"
        tests:
          - not_null

      - name: direct_payments
        description: "Stage 3a: Count of non-trial subscriptions with successful payment"
        tests:
          - not_null

      - name: paid_successfully
        description: "Stage 3: Count of sessions with successful payment"
        tests:
          - not_null

      - name: activation_rate
        description: "Stage 1 rate: subscriptions_activated / total_sessions"

      - name: trial_rate
        description: "Stage 2 rate: trials_started / total_sessions"

      - name: payment_rate
        description: "Stage 3 rate: paid_successfully / total_sessions"

      - name: conversions
        description: "Legacy: Count of sessions with subscription (use paid_successfully for actual payments)"
        tests:
          - not_null

      - name: conversion_rate
        description: "Legacy: Conversion rate (conversions / total_sessions)"

      - name: revenue_usd
        description: Sum of revenue from successful payments (USD)

      - name: avg_hours_to_convert
        description: Average hours from session to payment

      - name: users_with_amplitude_events
        description: Count of users who have Amplitude events

      - name: avg_events_per_user
        description: Average Amplitude events per user

  - name: mart_onboarding_analytics
    description: |
      Daily aggregate statistics of onboarding survey responses.
      Grain: One row per date + funnel + question + answer.

      Use cases:
      - Dashboard visualizations of answer distributions
      - Track survey response trends over time
      - Compare responses across funnels
      - All-time stats by aggregating: SUM(response_count) GROUP BY funnel_id, question, answer

      Key questions included:
      - Demographics: gender, age
      - Context: reason, start_period, intensity
      - Emotional state: overwhelmed_frequency, daily_emotional_experience, impact, emotional_support,
        worry_about_future, disconnected, emotional_ups_downs, emotionally_alone, sleep_difficulty, overthink_about_past
      - Goals: biggest_challenge, top_priority
    columns:
      - name: date
        description: Date of responses (UTC)
        tests:
          - not_null

      - name: funnel_id
        description: Funnel identifier
        tests:
          - not_null

      - name: funnel_title
        description: Funnel name (from funnels table)

      - name: question
        description: Question identifier (e.g., 'reason', 'gender', 'intensity')
        tests:
          - not_null

      - name: answer
        description: Answer value provided by user
        tests:
          - not_null

      - name: response_count
        description: Number of unique users who gave this answer
        tests:
          - not_null

      - name: question_total
        description: Total responses for this question on this date/funnel
        tests:
          - not_null

      - name: answer_percentage
        description: Percentage of responses (0.0 - 1.0)

  - name: mart_session_attribution
    description: |
      Session-level marketing attribution from Amplitude.
      Grain: One row per FunnelFox session with first-touch attribution.

      Use cases:
      - Facebook/Google/TikTok campaign performance
      - Traffic source breakdown (paid vs organic)
      - UTM parameter analysis
      - Click ID tracking for ad platform reconciliation

      Data linkage:
      - Joins FunnelFox sessions to Amplitude via fsid (session ID) in Page Location URL
      - fsid parameter in Amplitude event_properties->>'[Amplitude] Page Location'
      - Direct session-to-session link (most accurate)
    columns:
      - name: session_id
        description: FunnelFox session ID (primary key)
        tests:
          - unique
          - not_null

      - name: profile_id
        description: FunnelFox user profile ID
        tests:
          - not_null

      - name: session_date
        description: Date of session (UTC)
        tests:
          - not_null

      - name: session_timestamp
        description: Exact timestamp of session

      - name: funnel_id
        description: Funnel identifier

      - name: funnel_title
        description: Funnel name

      - name: funnel_type
        description: Type of funnel

      - name: funnel_environment
        description: Funnel environment (dev, staging, prod)

      - name: country
        description: User's country

      - name: city
        description: User's city

      - name: funnel_origin
        description: Original FunnelFox origin (funnel path/URL)

      - name: utm_source
        description: UTM source parameter (e.g., facebook, google)

      - name: utm_medium
        description: UTM medium parameter (e.g., cpc, paid, email)

      - name: utm_campaign
        description: UTM campaign name

      - name: utm_content
        description: UTM content (ad creative identifier)

      - name: utm_term
        description: UTM term (keywords)

      - name: fbclid
        description: Facebook Click ID (for FB Ads attribution)

      - name: gclid
        description: Google Click ID (for Google Ads attribution)

      - name: msclkid
        description: Microsoft Click ID (for Bing Ads attribution)

      - name: ttclid
        description: TikTok Click ID (for TikTok Ads attribution)

      - name: initial_referrer
        description: Initial referrer URL

      - name: initial_referring_domain
        description: Initial referring domain

      - name: traffic_source_category
        description: Categorized traffic source (Facebook Ads, Google Ads, Organic, etc.)
        tests:
          - accepted_values:
              values: ['Facebook Ads', 'Google Ads', 'Microsoft Ads', 'TikTok Ads', 'Twitter/X Ads', 'LinkedIn Ads', 'Paid (Other)', 'Email', 'Organic Social', 'Organic Search', 'Referral', 'Direct', 'Other']

      - name: is_paid_traffic
        description: Boolean flag for paid traffic (has click ID or paid UTM medium)

      - name: ad_platform
        description: Ad platform detected from click ID (Facebook, Google, Microsoft, TikTok, Twitter, LinkedIn)

      - name: has_attribution
        description: Boolean flag indicating if session has any attribution data

  - name: mart_marketing_attribution
    description: |
      Comprehensive session-level marketing attribution combining Facebook Ads,
      FunnelFox sessions, Amplitude events, and Stripe payments.
      Grain: One row per FunnelFox session.

      Use cases:
      - ROAS analysis (Return on Ad Spend)
      - CAC calculation (Customer Acquisition Cost)
      - Funnel performance by ad campaign/adset/ad
      - Full attribution: ad spend → clicks → sessions → conversions → revenue
      - Cohort LTV by acquisition source
      - Amplitude engagement correlation with conversion

      Data flow:
      - Facebook Ads (spend/impressions/clicks by ad_id)
      - FunnelFox Sessions (UTM params, fbclid, ad_id in origin)
      - Amplitude Events (aggregated per session via ff_session_id)
      - Stripe Payments (revenue via subscription linkage)
    columns:
      - name: session_id
        description: FunnelFox session ID (primary key)
        tests:
          - unique
          - not_null

      - name: profile_id
        description: User profile ID
        tests:
          - not_null

      - name: session_timestamp
        description: Session start timestamp

      - name: session_date
        description: Session date (UTC)
        tests:
          - not_null

      - name: origin_raw
        description: Original origin field, unmodified

      - name: user_agent
        description: Browser/device user agent

      - name: ip_address
        description: User IP address

      - name: utm_source
        description: Parsed UTM source (e.g., facebook, google)

      - name: utm_medium
        description: Parsed UTM medium (e.g., cpc, paid)

      - name: utm_campaign
        description: Parsed UTM campaign name

      - name: utm_content
        description: Parsed UTM content (ad creative identifier)

      - name: utm_term
        description: Parsed UTM term (keyword)

      - name: fbclid
        description: Facebook Click ID

      - name: ad_id
        description: Facebook ad ID from URL parameter

      - name: facebook_ad_id
        description: Matched Facebook ad ID

      - name: facebook_adset_id
        description: Facebook adset ID

      - name: facebook_campaign_id
        description: Facebook campaign ID

      - name: ad_name
        description: Facebook ad creative name

      - name: adset_name
        description: Facebook adset name

      - name: campaign_name
        description: Facebook campaign name

      - name: campaign_objective
        description: Facebook campaign objective

      - name: total_events
        description: Total Amplitude events in session
        tests:
          - not_null

      - name: unique_event_types
        description: Count of distinct Amplitude event types
        tests:
          - not_null

      - name: first_event_at
        description: First Amplitude event timestamp

      - name: last_event_at
        description: Last Amplitude event timestamp

      - name: session_duration_seconds
        description: Duration between first and last event

      - name: event_types_list
        description: Array of distinct event types

      - name: event_counts_json
        description: JSON object with event type counts

      - name: amplitude_device_id
        description: Amplitude device identifier

      - name: amplitude_platform
        description: Platform (iOS, Android, Web)

      - name: amplitude_os_version
        description: OS version

      - name: amplitude_country
        description: Country from Amplitude

      - name: amplitude_city
        description: City from Amplitude

      - name: funnel_id
        description: Funnel identifier

      - name: funnel_title
        description: Funnel name

      - name: funnel_type
        description: Funnel type

      - name: funnel_environment
        description: Funnel environment (dev, staging, prod)

      - name: funnel_version
        description: Funnel version at session time

      - name: country
        description: User's country (FunnelFox)

      - name: city
        description: User's city (FunnelFox)

      - name: converted
        description: Whether session resulted in subscription
        tests:
          - not_null

      - name: conversion_timestamp
        description: Timestamp of conversion

      - name: hours_to_convert
        description: Hours from session to conversion

      - name: revenue_usd
        description: Revenue from this session (USD)

      - name: currency
        description: Original currency code

      - name: payment_status
        description: Payment status (succeeded)

      - name: subscription_id
        description: Stripe subscription ID

      - name: subscription_status
        description: Subscription status

      - name: is_paid_traffic
        description: True if UTM medium indicates paid traffic or has fbclid/gclid
        tests:
          - not_null

      - name: is_facebook_traffic
        description: True if utm_source is facebook/fb or has fbclid
        tests:
          - not_null

      - name: attribution_channel
        description: Categorized attribution channel (facebook_paid, google_paid, organic, etc.)
        tests:
          - not_null

  - name: mart_stripe_risk_metrics
    description: |
      Daily risk metrics including fraud warnings, chargebacks, and refunds.
      Grain: One row per day.

      Use cases:
      - Daily Visa/Mastercard program compliance monitoring
      - VAMP (Visa Acquirer Monitoring Program) metrics tracking
      - Chargeback rate tracking by card network
      - Early Fraud Warning (EFW) monitoring
      - RDR (Rapid Dispute Resolution) tracking
      - Refund volume analysis

      Key metrics:
      - EFW count/amount: Early Fraud Warnings received
      - Chargeback counts: By Mastercard, Visa (excl RDR), Other
      - Chargeback rates: Disputes today / successful txns previous 30 days (rolling)
      - VAMP: EFW count + Visa chargebacks (Visa's fraud monitoring threshold)
      - RDR: Visa disputes resolved through Rapid Dispute Resolution
      - Refunds: Total refund count and amount
    columns:
      - name: date
        description: The date
        tests:
          - unique
          - not_null

      - name: efw_count
        description: Count of Early Fraud Warnings received
        tests:
          - not_null

      - name: efw_amount_usd
        description: Total USD amount of charges with EFW
        tests:
          - not_null

      - name: chb_count_mastercard
        description: Count of Mastercard chargebacks (disputes opened)
        tests:
          - not_null

      - name: chb_amount_mastercard
        description: USD amount of Mastercard chargebacks
        tests:
          - not_null

      - name: chb_count_visa
        description: Count of Visa chargebacks (disputes opened, excluding RDR)
        tests:
          - not_null

      - name: chb_amount_visa
        description: USD amount of Visa chargebacks (excluding RDR)
        tests:
          - not_null

      - name: chb_count_other
        description: Count of chargebacks for other card brands
        tests:
          - not_null

      - name: chb_amount_other
        description: USD amount of chargebacks for other card brands
        tests:
          - not_null

      - name: total_chb_count
        description: Total count of all chargebacks
        tests:
          - not_null

      - name: total_chb_amount_usd
        description: Total USD amount of all chargebacks
        tests:
          - not_null

      - name: rdr_count
        description: Count of Visa RDR (Rapid Dispute Resolution) disputes
        tests:
          - not_null

      - name: rdr_amount_usd
        description: USD amount of Visa RDR disputes
        tests:
          - not_null

      - name: chb_rate_mastercard
        description: Mastercard chargeback rate (disputes today / successful MC txns previous 30 days)

      - name: chb_rate_visa
        description: Visa chargeback rate (disputes today / successful Visa txns previous 30 days)

      - name: vamp_count
        description: VAMP count (EFW count + Visa chargeback count) - Visa monitoring threshold
        tests:
          - not_null

      - name: vamp_rate
        description: VAMP rate (VAMP count / Visa successful transactions this month)

      - name: refund_count
        description: Count of processed refunds
        tests:
          - not_null

      - name: refund_amount_usd
        description: Total USD amount of refunds
        tests:
          - not_null

      - name: mc_successful_count
        description: Count of successful Mastercard transactions (for reference)
        tests:
          - not_null

      - name: visa_successful_count
        description: Count of successful Visa transactions (for reference)
        tests:
          - not_null

      - name: total_successful_count
        description: Count of all successful transactions (for reference)
        tests:
          - not_null

  - name: mart_marketing_performance
    description: |
      Comprehensive marketing performance metrics combining Facebook Ads
      statistics with attributed conversions, installs, and revenue for ROAS analysis.
      Grain: One row per date + campaign + adset + ad.

      Data Sources:
      - Facebook Ads statistics (spend, impressions, clicks, video metrics)
      - Facebook campaign/adset/ad metadata
      - AppsFlyer installs (mobile app installs with attribution)
      - Attributed conversions from mart_marketing_attribution (real revenue)
      - Amplitude events (funnel step conversions)

      Use cases:
      - Daily/weekly/monthly marketing performance dashboards
      - ROAS and CAC analysis by campaign/adset/ad
      - Full funnel tracking (clicks → installs → registrations → purchases)
      - Video engagement metrics (hook rate, hold rate)
      - Funnel step conversion rates (CR 1to2scr, CR to paywall, pCVR, upsell CR)
      - LTV and ROI projections
    columns:
      - name: date
        description: Date of the metrics
        tests:
          - not_null

      - name: facebook_campaign_id
        description: Facebook campaign identifier
        tests:
          - not_null

      - name: facebook_adset_id
        description: Facebook adset identifier
        tests:
          - not_null

      - name: facebook_ad_id
        description: Facebook ad identifier
        tests:
          - not_null

      - name: funnel_id
        description: FunnelFox funnel identifier (dominant funnel for this campaign based on session count)

      - name: funnel_title
        description: FunnelFox funnel name

      - name: campaign_name
        description: Facebook campaign name

      - name: adset_name
        description: Facebook adset name

      - name: ad_name
        description: Facebook ad creative name

      - name: campaign_objective
        description: Campaign objective (CONVERSIONS, LEAD_GENERATION, etc.)

      - name: campaign_status
        description: Campaign status (ACTIVE, PAUSED, etc.)

      - name: adset_status
        description: Adset status

      - name: ad_status
        description: Ad status

      - name: target_countries
        description: Target countries for the adset

      - name: spend_usd
        description: Total spend in USD

      - name: impressions
        description: Total impressions

      - name: clicks
        description: Total clicks

      - name: unique_clicks
        description: Unique clicks

      - name: cpm
        description: Cost per mille (spend / impressions * 1000)

      - name: cpc
        description: Cost per click (spend / clicks)

      - name: ctr
        description: Click-through rate (clicks / impressions)

      - name: video_3_sec_plays
        description: 3-second video plays

      - name: thru_plays
        description: Video thru-plays (watched to completion)

      - name: hook_rate
        description: Video hook rate (3-sec plays / impressions) - measures initial video engagement

      - name: hold_rate
        description: Video hold rate (thru-plays / 3-sec plays) - measures video retention

      - name: views_to_click_rate
        description: Views to click rate (clicks / impressions)

      - name: installs
        description: App installs from AppsFlyer with Facebook attribution

      - name: cost_per_install
        description: Cost per install (spend / installs) - CPI metric

      - name: click_to_install_rate
        description: Click to install rate (installs / clicks)

      - name: registrations
        description: Facebook-attributed registrations

      - name: purchases
        description: Facebook-attributed purchases (FTD - First Time Deposit)

      - name: leads
        description: Facebook-attributed leads

      - name: clicks_to_regs_rate
        description: Clicks to registrations rate

      - name: regs_to_purchase_rate
        description: Registrations to purchase rate (R2D - Registration to Deposit)

      - name: clicks_to_purchase_rate
        description: Clicks to purchase rate

      - name: install_to_reg_rate
        description: Install to registration rate (Inst2Reg)

      - name: reg_to_ftd_rate
        description: Registration to FTD rate (R2D - same as regs_to_purchase_rate)

      - name: cost_per_registration
        description: Cost per registration (spend / registrations) - $REG metric

      - name: cost_per_ftd
        description: Cost per FTD/purchase (spend / purchases) - $FTD metric

      - name: cr_1to2_screen
        description: |
          CR 1to2scr - First screen to second screen conversion rate.
          Calculated from Amplitude events (onboarding_started/quiz_started → step_completed/question_answered)

      - name: cr_to_paywall
        description: |
          CR to paywall - Percentage of sessions that reached the paywall screen.
          Calculated from Amplitude paywall_shown/paywall_presented events

      - name: paywall_cvr
        description: |
          pCVR - Paywall conversion rate (purchases / paywall views).
          Measures conversion rate at the paywall step

      - name: upsell_cr
        description: |
          Upsell CR - Upsell conversion rate (upsell_completed / upsell_shown).
          Measures conversion rate on upsell offers

      - name: attributed_sessions
        description: Sessions attributed to this ad (from our attribution)

      - name: attributed_users
        description: Unique users attributed to this ad

      - name: attributed_conversions
        description: Conversions attributed to this ad (from our attribution)

      - name: revenue_usd
        description: Revenue attributed to this ad (from our attribution)

      - name: roas
        description: Return on Ad Spend (revenue / spend)

      - name: arpu
        description: Average Revenue Per User (revenue / conversions)

      - name: cac
        description: Customer Acquisition Cost (spend / conversions)


  - name: mart_master_charges
    description: |
      Master charges mart - single source of truth for all Stripe payment analytics.
      Grain: One row per Stripe charge.

      Data Sources:
      - raw_stripe.charges: Core payment data
      - raw_stripe.refunds: Refund details
      - raw_funnelfox.subscriptions: FunnelFox linkage (nullable)
      - raw_funnelfox.sessions: User session data (nullable)
      - raw_funnelfox.funnels: Funnel metadata (nullable)

      Use cases:
      - Payment success/failure analysis
      - Risk metrics (disputes, fraud blocks, high-risk transactions)
      - Refund tracking
      - Subscription analytics
      - Funnel attribution
      - Replaces: mart_stripe_payments, mart_stripe_risk_metrics, mart_new_subscriptions
    columns:
      - name: charge_id
        description: Stripe charge ID (primary key)
        tests:
          - unique
          - not_null

      - name: payment_intent_id
        description: Payment intent ID (groups retry attempts)

      - name: customer_id
        description: Stripe customer ID

      - name: invoice_id
        description: Stripe invoice ID

      - name: amount_usd
        description: Payment amount in USD
        tests:
          - not_null

      - name: currency
        description: Original currency code

      - name: status
        description: Payment status (succeeded, failed, pending)
        tests:
          - not_null
          - accepted_values:
              values: ['succeeded', 'failed', 'pending']

      - name: is_successful
        description: Boolean flag for successful payment
        tests:
          - not_null

      - name: failure_code
        description: Raw Stripe failure code

      - name: failure_category
        description: Categorized failure type
        tests:
          - accepted_values:
              values: ['insufficient_funds', 'card_declined', 'fraud_block', 'authentication_required', 'expired_card', 'invalid_card', 'processing_error', 'technical_error']
              config:
                where: "status = 'failed'"

      - name: recovery_action
        description: Suggested recovery action
        tests:
          - accepted_values:
              values: ['retry_eligible', 'request_new_card', 'verify_3ds', 'contact_support']
              config:
                where: "status = 'failed'"

      - name: description
        description: Payment description from Stripe (e.g., "Subscription creation", "Subscription update", "Payment for invoice")

      - name: attempt_number
        description: Attempt number within payment intent (1, 2, 3...)
        tests:
          - not_null

      - name: is_first_attempt
        description: True if this is the first attempt for this payment intent
        tests:
          - not_null

      - name: is_final_attempt
        description: True if this is the last/most recent attempt for this payment intent
        tests:
          - not_null

      - name: intent_eventually_succeeded
        description: True if any attempt in this payment intent succeeded
        tests:
          - not_null

      - name: card_brand
        description: Card brand (visa, mastercard, etc.)

      - name: card_country
        description: Card issuing country

      - name: card_funding
        description: Card funding type (credit, debit, prepaid)

      - name: card_last4
        description: Last 4 digits of card

      - name: card_bin
        description: Card BIN (Bank Identification Number) - first 6 digits

      - name: card_issuer
        description: Card issuing bank/institution

      - name: card_product
        description: Card product type (e.g., World, Platinum)

      - name: customer_country
        description: Customer billing country

      - name: risk_level
        description: Stripe Radar risk level (normal, elevated, highest)

      - name: risk_score
        description: Stripe Radar risk score (0-100)

      - name: outcome_type
        description: Payment outcome type (authorized, blocked, etc.)

      - name: outcome_reason
        description: Outcome reason if blocked

      - name: is_blocked
        description: True if payment was blocked by Stripe Radar
        tests:
          - not_null

      - name: is_fraud_decline
        description: True if declined for fraud-related reasons
        tests:
          - not_null

      - name: is_disputed
        description: True if charge has a dispute/chargeback
        tests:
          - not_null

      - name: dispute_id
        description: Stripe dispute ID if disputed

      - name: is_refunded
        description: True if charge has been refunded
        tests:
          - not_null

      - name: refund_amount_usd
        description: Total refunded amount in USD
        tests:
          - not_null

      - name: is_fully_refunded
        description: True if fully refunded
        tests:
          - not_null

      - name: refund_ratio
        description: Refund amount / charge amount

      - name: net_revenue_usd
        description: Net revenue after refunds (amount_usd - refund_amount_usd)
        tests:
          - not_null

      - name: intent_status
        description: Payment intent status

      - name: intent_canceled_at
        description: Payment intent cancellation timestamp (if canceled)

      - name: intent_cancellation_reason
        description: Reason for payment intent cancellation

      - name: intent_description
        description: Payment intent description

      - name: intent_created_at
        description: Payment intent creation timestamp

      - name: profile_id
        description: FunnelFox user profile ID (nullable)

      - name: ff_subscription_id
        description: FunnelFox subscription ID (nullable)

      - name: ff_subscription_status
        description: FunnelFox subscription status (nullable)

      - name: payment_provider
        description: Payment provider (stripe, apple, google)

      - name: billing_interval
        description: Billing interval (month, year, etc.)

      - name: billing_interval_count
        description: Number of billing intervals

      - name: subscription_price_usd
        description: FunnelFox subscription price in USD

      - name: product_name
        description: Stripe product name from products catalog

      - name: funnel_id
        description: Funnel ID (nullable)

      - name: funnel_name
        description: Funnel name (nullable)

      - name: funnel_type
        description: Funnel type (nullable)

      - name: funnel_environment
        description: Funnel environment (nullable)

      - name: country
        description: User country from session (nullable)

      - name: city
        description: User city from session (nullable)

      - name: traffic_source
        description: Traffic source/origin (nullable)

      - name: first_session_at
        description: First session timestamp (nullable)

      - name: created_at
        description: Charge creation timestamp
        tests:
          - not_null

      - name: created_date
        description: Charge date (UTC)
        tests:
          - not_null

      - name: hour_of_day
        description: Hour of day (0-23)

      - name: day_of_week
        description: Day of week name

      - name: week_start_date
        description: Monday of the week

      - name: month_start_date
        description: First of the month

      - name: is_organic
        description: True if no FunnelFox linkage (organic/direct)
        tests:
          - not_null
